# å¦‚ä½•åœ¨äº‘ä¸­è¿è¡Œå®šåˆ¶çš„ Tensorflow åŸ¹è®­

> åŸæ–‡ï¼š<https://towardsdatascience.com/how-to-run-customized-tensorflow-training-in-the-cloud-d0c142e3cfb5?source=collection_archive---------9----------------------->

æ‚¨çš„ Tensorflow ä»£ç åœ¨æœ¬åœ°è¿è¡Œã€‚ç°åœ¨ï¼Œæ‚¨å¸Œæœ›åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®å®ƒï¼Œä»¥è·å¾—æ‰€æœ‰é¢å¤–çš„ GPU åŠŸèƒ½ã€‚æœ‰ä¸¤ç§é€‰æ‹©ã€‚æ¯”è¾ƒæµè¡Œçš„ä¸¤ä¸ªæ‰˜ç®¡ ML äº‘å¹³å°æ˜¯ Google Cloud ML Engine å’Œ AWS Sage Makerã€‚å®ƒä»¬è®©æ‚¨å¿«é€Ÿéƒ¨ç½²æ‚¨çš„æ¨¡å‹å¹¶è®­ç»ƒå®ƒä»¬ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯èƒ½æƒ³è¦æ„å»ºä¸€ä¸ªæ›´åŠ å®šåˆ¶åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [AWS æ‰¹æ¬¡](https://aws.amazon.com/batch/)ã€‚

## **ä¸ºä»€ä¹ˆ AWS æ‰¹é‡ï¼Ÿ**

è¿™é‡Œçš„ä¸»è¦æ€æƒ³æ˜¯å°½å¯èƒ½é™ä½æˆæœ¬ï¼ŒåŒæ—¶ä»ç„¶åˆ©ç”¨ GPU çš„èƒ½åŠ›ã€‚æŒç»­è¿è¡Œ GPU å®ä¾‹ä¼šäº§ç”Ÿå·¨å¤§çš„æˆæœ¬ã€‚AWS batch ä½¿ç”¨ä¸€ä¸ªä½œä¸šé˜Ÿåˆ—ï¼Œå¹¶æ ¹æ®ä½œä¸šéœ€æ±‚æ‰©å±•å®ä¾‹ã€‚å› æ­¤ï¼Œå¦‚æœæ²¡æœ‰ä½œä¸šï¼Œå°±æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹ã€‚é€šè¿‡ä½¿ç”¨[ç‚¹å®ä¾‹](https://aws.amazon.com/ec2/spot/)ï¼Œæ‚¨å¯ä»¥è¿›ä¸€æ­¥é™ä½è¿è¡ŒåŸ¹è®­å·¥ä½œçš„æˆæœ¬ã€‚

## **å…ˆå†³æ¡ä»¶:**

*   AWS è´¦æˆ·:[https://aws.amazon.com/console](https://aws.amazon.com/console)ã€‚
*   ç”¨äºéƒ¨ç½²çš„ AWS å‘½ä»¤è¡Œ:[https://aws.amazon.com/cli/](https://aws.amazon.com/cli/)ã€‚
*   https://docs.docker.com/install/ã€‚

## **æ„å»º Docker æ˜ åƒ**

AWS æ‰¹å¤„ç†éœ€è¦ä¸€ä¸ª docker æ˜ åƒï¼Œæ‚¨çš„ Tensorflow è®­ç»ƒä»£ç å°†åœ¨å…¶ä¸­è¿è¡Œã€‚Dockerfile æ–‡ä»¶å¦‚ä¸‹ã€‚

*   å®‰è£…æ‰€éœ€çš„ç›¸å…³ cuda åŸºç¡€æ˜ åƒå’Œåº“ï¼Œä»è¿™é‡Œè·å–[https://github . com/tensor flow/tensor flow/blob/master/tensor flow/tools/docker/docker file . GPU](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/tools/docker/Dockerfile.gpu)(ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ)ã€‚
*   å¤åˆ¶æ‚¨çš„ä»£ç ä½¿ç”¨çš„ Pipfile å¹¶å°†å…¶å®‰è£…åœ¨æ˜ åƒä¸Šã€‚Pipfile ä¹Ÿåº”è¯¥åŒ…å« Tensorflow ç‰ˆæœ¬ã€‚
*   è®¾ç½®ç›¸å…³çš„ç¯å¢ƒå˜é‡ã€‚
*   å¤åˆ¶è·å–å¹¶è¿è¡Œè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†åœ¨ s3 ä¸Šè·å–ä¸€ä¸ª shell è„šæœ¬(ç¨åå°†è¯¦ç»†ä»‹ç»)æ¥å¤„ç† Tensorflow ä»£ç çš„è¿è¡Œ(ä¹Ÿé©»ç•™åœ¨ S3 ä¸Š)ã€‚

$RUN_SCRIPT å‚æ•°å°†ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ AWS æ‰¹å¤„ç†ä½œä¸šã€‚

æ¥ä¸‹æ¥ï¼Œæ„å»ºæ˜ åƒå¹¶å°†å…¶æ¨é€åˆ° docker å­˜å‚¨åº“ï¼Œä»¥ä¾¿æ‰¹å¤„ç†ä½œä¸šå¯ä»¥è®¿é—®å®ƒã€‚

```
> docker build -t $DOCKER_IMAGE_TAG aws_batch_image
> docker push $DOCKER_IMAGE_TAG
```

aws_batch_image æ˜¯ä¸€ä¸ªåŒ…å« docker æ–‡ä»¶ä»¥åŠè·å–å’Œè¿è¡Œè„šæœ¬çš„æ–‡ä»¶å¤¹ã€‚

## **å»ºç«‹ AMI**

Tensorflow ä¾èµ–äºç‰¹å®šçš„ NVIDIA é©±åŠ¨ç¨‹åºå’Œè½¯ä»¶åŒ…æ¥è¿è¡Œã€‚ä½ å¯ä»¥ä½¿ç”¨ AWS Deeplearning AMI ï¼Œå®ƒé™„å¸¦äº†ä¸€ç»„é¢„è£…çš„é©±åŠ¨ç¨‹åºï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥è‡ªå·±æ„å»ºä¸€ä¸ªã€‚æˆ‘å°†é€šè¿‡å„ç§æ­¥éª¤æ¥æ„å»ºæ‚¨çš„è‡ªå®šä¹‰ Tensorflow AMIã€‚

**åˆ›å»ºä¸€ä¸ª GPU åŸºç¡€ AMI**

ä» Amazon EC2 ä»ªè¡¨æ¿åˆ›å»º Amazon Linux AMIã€‚æˆ‘ä»¬å°†ä½¿ç”¨å¸¦æœ‰ 16GB é€šç”¨ SSD å·å­˜å‚¨çš„ p2.xlarge å®ä¾‹ã€‚ç¡®ä¿ç”Ÿæˆä¸€ä¸ªå®šåˆ¶çš„å¯†é’¥å¯¹ï¼Œæ‚¨å¯ä»¥ç”¨å®ƒæ¥ SSH åˆ°å®ä¾‹ä¸­ã€‚

**å®‰è£… NVIDIA é©±åŠ¨**

é¦–å…ˆä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† ssh è¿æ¥åˆ°æ‚¨çš„å®ä¾‹ã€‚

```
> ssh -i custom-key-pair.pem ec2-user@<Public DNS> 
```

è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚

```
# Update package cache and get package updates
> sudo yum update -y# Installs gcc compiler and kernel header package
> sudo yum install -y gcc kernel-devel-$(uname -r)
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…åŸºäº Tensorflow ç‰ˆæœ¬çš„ NVIDIA é©±åŠ¨ç¨‹åºã€‚P2 å®ä¾‹åŒ…å«ç‰¹æ–¯æ‹‰ K-80 GPU çš„ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸ CUDA Toolkit 8.0 å…¼å®¹çš„ Tensorflow 1.3ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªé“¾æ¥å¸®åŠ©æ‰¾åˆ°å…¼å®¹çš„é©±åŠ¨ç¨‹åº[http://www.nvidia.com/Download/Find.aspx](http://www.nvidia.com/Download/Find.aspx)ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ç‰ˆæœ¬ 367.106ã€‚

ä¸‹è½½é©±åŠ¨ç¨‹åºå®‰è£…æ–‡ä»¶ã€‚

```
> wget http://us.download.nvidia.com/XFree86/Linux-x86_64/367.106/NVIDIA-Linux-x86_64-367.106.run
```

è¿è¡Œå®‰è£…æ–‡ä»¶ï¼Œç„¶åé‡æ–°å¯åŠ¨ã€‚

```
> sudo /bin/bash ./NVIDIA-Linux-x86_64-367.106.runVerifying archive integrity... OKUncompressing NVIDIA Accelerated Graphics Driver for Linux-x86_64 367.106............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................> sudo reboot
```

SSH åˆ°æ‚¨çš„å®ä¾‹ä¸­ï¼Œå¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•é©±åŠ¨ç¨‹åºæ˜¯å¦å®‰è£…æ­£ç¡®ã€‚

```
> nvidia-smi -q | head==============NVSMI LOG==============Timestamp                           : Tue Apr 10 11:01:04 2018Driver Version                      : 367.106Attached GPUs                       : 1GPU 0000:00:1E.0Product Name                    : Tesla K80Product Brand                   : Tesla
```

å¦‚æœæ‚¨é€‰æ‹©çš„é©±åŠ¨ç¨‹åºä¸èµ·ä½œç”¨ï¼Œè¯·å°è¯•ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬ã€‚

**é…ç½® nvidia-docker**

NVIDIA Docker RPM å®‰è£…å°† NVIDIA é©±åŠ¨ç¨‹åºå¤åˆ¶åˆ° AWS æ‰¹å¤„ç†ä½œä¸šä¸­ Docker å®¹å™¨çš„æ­£ç¡®ä½ç½®æ‰€éœ€çš„ç»„ä»¶ã€‚

ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»ºä¸€ä¸ª bash è„šæœ¬æ–‡ä»¶ã€‚

è¿è¡Œè¯¥è„šæœ¬ï¼ŒéªŒè¯æ‚¨å¯ä»¥è¿è¡Œ docker å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¿é—®å·²å®‰è£…çš„é©±åŠ¨ç¨‹åºã€‚

```
> ./configure_nvidia_gpu.sh> sudo docker run --privileged -v /var/lib/nvidia-docker/volumes/nvidia_driver/latest:/usr/local/nvidia nvidia/cuda:8.0-cudnn6-devel nvidia-smi
```

æ‚¨åº”è¯¥å¾—åˆ°ç±»ä¼¼äºä¸‹é¢çš„è¾“å‡ºã€‚

![](img/271813fa86dae6a791d1a5f97632b707.png)

åˆ é™¤å®ä¾‹ä¸Šçš„ docker å®¹å™¨å’Œæ˜ åƒï¼Œä»¥å‡å° AMI çš„å¤§å°ã€‚

```
> sudo docker rm $(sudo docker ps -aq)
> sudo docker rmi $(sudo docker images -q)
```

**ä»å®ä¾‹ä¸­åˆ›å»º AMI**

1.  é¦–å…ˆï¼Œåˆ›å»ºå›¾åƒçš„å¿«ç…§ã€‚å¯ä»¥å‚è€ƒè¿™é‡Œ[https://docs . AWS . Amazon . com/AWS C2/latest/user guide/EBS-creating-snapshot . html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html)ã€‚
2.  ä» EC2 ä»ªè¡¨æ¿ä¸­é€‰æ‹©æ‚¨çš„å®ä¾‹ï¼Œå¹¶é€‰æ‹©**æ“ä½œ**ã€**å›¾åƒ**ã€**åˆ›å»ºå›¾åƒ**ã€‚
3.  å¦‚ä¸‹å¡«å†™å­—æ®µ(æˆ‘å·²ç»å°†å¿«ç…§ ID å’Œå®ä¾‹ Id å˜ç™½)ã€‚

![](img/590814fc5ca81c35be02c58a5ae18ff8.png)

4.å•å‡»åˆ›å»ºå›¾åƒã€‚

æ‚¨çš„ ami ç°åœ¨åº”è¯¥æ˜¾ç¤ºåœ¨ AMIs éƒ¨åˆ†ã€‚çŠ¶æ€å˜ä¸ºå¯ç”¨å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ã€‚

# è®¾ç½® AWS æ‰¹

**å…ˆå†³æ¡ä»¶**

1.  åˆ›å»º AWS æ‰¹å¤„ç†æœåŠ¡è§’è‰²ã€‚å‚è€ƒ[è¿™é‡Œçš„](https://docs.aws.amazon.com/batch/latest/userguide/service_IAM_role.html)è·å–ä¿¡æ¯ã€‚
2.  åˆ›å»ºä¸€ä¸ª ecsInstanceRoleã€‚å‚è€ƒ[æ­¤å¤„çš„](https://docs.aws.amazon.com/batch/latest/userguide/instance_IAM_role.html)è·å–ä¿¡æ¯ã€‚
3.  åˆ›å»ºä¸€ä¸ª EC2SpotFleetRoleã€‚å‚è€ƒ[æ­¤å¤„](https://docs.aws.amazon.com/batch/latest/userguide/spot_fleet_IAM_role.html)è·å–ä¿¡æ¯ã€‚
4.  åˆ›å»ºä¸€ä¸ª EC2 å¯†é’¥å¯¹ã€‚å‚è€ƒ[æ­¤å¤„](https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html#create-a-key-pair)è·å–ä¿¡æ¯ã€‚
5.  åˆ›å»ºä¸€ä¸ª EC2ContainerServiceTask è§’è‰²ï¼Œå¹¶ä¸ºå…¶é™„åŠ ä¸€ä¸ª AmazonS3FullAccess ç­–ç•¥ã€‚

AWS æ‰¹å¤„ç†å¯ä»¥é€šè¿‡ GUI æˆ–å‘½ä»¤è¡Œè®¾ç½®ã€‚æˆ‘ä»¬å°†é€šè¿‡å‘½ä»¤è¡Œå®Œæˆè®¾ç½®è¿‡ç¨‹ã€‚å¦‚æœä½ æƒ³é€šè¿‡å›¾å½¢ç”¨æˆ·ç•Œé¢æ¥è®¾ç½®å®ƒï¼Œè¯·éµå¾ªè¿™é‡Œçš„æ•™ç¨‹[å¹¶å¡«å†™ä¸‹é¢ç»™å‡ºçš„ä¿¡æ¯ã€‚](https://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html)

**åˆ›å»ºè®¡ç®—ç¯å¢ƒ**

åˆ›å»ºä¸€ä¸ª JSON æ–‡ä»¶æ¥æŒ‡å®šè®¡ç®—ç¯å¢ƒçš„å„ç§å±æ€§ã€‚

**ç±»å‹**:æˆ‘ä»¬é€‰æ‹© managedï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ› AWS Batch è´Ÿè´£è°ƒåº¦å’Œç®¡ç†èµ„æºã€‚

**çŠ¶æ€**:è¡¨ç¤ºæ‚¨ç°åœ¨æ˜¯å¦æƒ³è¦æ¿€æ´»ã€‚æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º enabledã€‚

**è®¡ç®—èµ„æº:**

*   **ç±»å‹**:ç°åœºå®ä¾‹æˆ–æŒ‰éœ€å®ä¾‹ã€‚é€‰æ‹© spot å®ä¾‹ä»¥é™ä½æˆæœ¬ã€‚
*   è¿™æ˜¯ä½ åœ¨ä¸Šé¢åˆ›å»ºçš„èˆ°é˜Ÿè§’è‰²çš„ arnã€‚

æç¤º:æ‚¨å¯ä»¥ä½¿ç”¨ cli è·å–æ‚¨çš„è§’è‰²çš„ arnï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
> aws iam get-role --role-name aws-batch-spot-fleet-role --query 'Role.Arn' --output text
```

*   minvCpus :ä¸ç®¡ä½œä¸šéœ€æ±‚å¦‚ä½•ï¼Œè¦ç»´æŠ¤çš„è™šæ‹Ÿ CPU çš„æœ€å°æ•°é‡ã€‚ä¸ºäº†èŠ‚çœæˆæœ¬ï¼Œæˆ‘ä»¬å°†å…¶è®¾ç½®ä¸ºé›¶ã€‚
*   **maxvCpus** :æˆ‘ä»¬å¸Œæœ›ä½œä¸šè¿è¡Œçš„è™šæ‹Ÿ CPU çš„æœ€å¤§æ•°é‡ã€‚
*   **desiredvCpus** :è®¡ç®—ç¯å¢ƒåœ¨å¯åŠ¨æ—¶åº”è¯¥æ‹¥æœ‰çš„è™šæ‹Ÿ CPU çš„æ•°é‡ã€‚éšç€éœ€æ±‚çš„å¢åŠ æˆ–å‡å°‘ï¼ŒAWS æ‰¹æ¬¡çš„æ•°é‡å°†åœ¨æœ€å¤§å€¼å’Œæœ€å°å€¼ä¹‹é—´è¿›è¡Œè°ƒæ•´ã€‚
*   **å®ä¾‹ç±»å‹**:è¦å¯åŠ¨çš„ EC2 å®ä¾‹çš„ç±»å‹ã€‚æˆ‘ä»¬å°†æŠŠå®ƒè®¾ç½®ä¸º p2.xlarge(æˆ‘ä»¬ç”¨æ¥åˆ›å»º AMI çš„åŒä¸€ä¸ªå®ä¾‹)ã€‚
*   **bidPercentage** :å®ä¾‹å¯åŠ¨å‰ï¼Œç°è´§å®ä¾‹ä»·æ ¼ä¸è¯¥å®ä¾‹ç±»å‹çš„æŒ‰éœ€ä»·æ ¼ç›¸æ¯”å¿…é¡»è¾¾åˆ°çš„æœ€å¤§ç™¾åˆ†æ¯”ã€‚
*   **å­ç½‘:**è¦åœ¨å…¶ä¸­è¿è¡Œæ‰¹å¤„ç†å®ä¾‹çš„è™šæ‹Ÿç§æœ‰äº‘(VPC)å­ç½‘ã€‚

æç¤º:æ‚¨å¯ä»¥ä» cli æŸ¥è¯¢æ‚¨çš„å­ç½‘ idï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
> aws ec2 describe-subnets
```

*   **security groupid:**æ‚¨å¸Œæœ›åº”ç”¨åˆ°æ‚¨çš„å®ä¾‹çš„å®‰å…¨ç»„çš„æ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚ SSH è®¿é—®ã€‚

æç¤º:æ‚¨å¯ä»¥ä» cli æŸ¥è¯¢æ‚¨çš„å®‰å…¨ç»„ idï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
> aws ec2 describe-security-groups
```

*   **ec2KeyPair:** ç”¨äº SSH è¿›å…¥å®ä¾‹ã€‚å°†å…¶è®¾ç½®ä¸ºæ‚¨åœ¨ä¸Šé¢åˆ›å»ºçš„å€¼ã€‚
*   **instanceRole** :å°†å…¶è®¾ç½®ä¸ºæ‚¨åœ¨ä¸Šé¢åˆ›å»ºçš„è§’è‰²çš„åç§°ã€‚

**serviceRole:** å°†å…¶è®¾ç½®ä¸ºæ‚¨åœ¨ä¸Šé¢åˆ›å»ºçš„è§’è‰²çš„åç§°ã€‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºè®¡ç®—ç¯å¢ƒã€‚

```
> aws batch create-compute-environment --cli-input-json file://<path_to_json_file>/compute_environment_spec.json
```

æ‚¨åº”è¯¥ä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚

![](img/e02f34dd5709b42f780d617b03226df0.png)

**åˆ›å»ºä½œä¸šé˜Ÿåˆ—**

åˆ›å»ºä¸€ä¸ª JSON æ–‡ä»¶æ¥æŒ‡å®šä½œä¸šé˜Ÿåˆ—å‚æ•°ã€‚

**jobQueueName:** ä½œä¸šé˜Ÿåˆ—çš„åç§°ã€‚

**çŠ¶æ€:**è¡¨ç¤ºæ‚¨å¸Œæœ›å®ƒç°åœ¨æ¿€æ´»ã€‚æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º enabledã€‚

**ä¼˜å…ˆçº§:**å½“ä¸ç›¸åŒçš„è®¡ç®—ç¯å¢ƒç›¸å…³è”æ—¶ï¼Œä¼˜å…ˆçº§å‚æ•°å…·æœ‰è¾ƒé«˜æ•´æ•°å€¼çš„ä½œä¸šé˜Ÿåˆ—é¦–å…ˆè¢«è¯„ä¼°ã€‚æˆ‘ä»¬ä½¿ç”¨å•ç‹¬çš„è®¡ç®—ç¯å¢ƒè¿›è¡ŒåŸ¹è®­ï¼Œå› æ­¤æˆ‘ä»¬åªå°†å…¶è®¾ç½®ä¸º 1ã€‚

**è®¡ç®—ç¯å¢ƒæ¸…å•:**

*   **é¡ºåº:**ä½œä¸šè°ƒåº¦å™¨ä½¿ç”¨è¯¥å‚æ•°æ¥ç¡®å®šå“ªä¸ªè®¡ç®—ç¯å¢ƒåº”è¯¥æ‰§è¡Œç»™å®šçš„ä½œä¸šã€‚
*   **è®¡ç®—ç¯å¢ƒ:**è®¡ç®—ç¯å¢ƒçš„åç§°ã€‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä½œä¸šé˜Ÿåˆ—ã€‚

```
> aws batch create-job-queue --cli-input-json file://<path_to_json_file>/job_queue_spec.json
```

è¾“å‡ºåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/b0f090a7caf0f29ac4c86522fbe806e6.png)

**ç™»è®°å·¥ä½œå®šä¹‰**

åˆ›å»ºä¸€ä¸ª JSON æ–‡ä»¶æ¥æŒ‡å®šä½œä¸šå®šä¹‰å‚æ•°ã€‚

**ä½œä¸šå®šä¹‰åç§°:**ä½œä¸šå®šä¹‰çš„åç§°ã€‚

**ç±»å‹:**ä½œä¸šçš„ç±»å‹ã€‚ç›®å‰åªæ”¯æŒå®¹å™¨ç±»å‹ã€‚

**å®¹å™¨å±æ€§:**

*   **å›¾ç‰‡:**ä½ ä¸Šé¢åˆ›å»ºçš„ docker å›¾ç‰‡çš„æ ‡ç­¾ã€‚
*   **vcpu:**å·¥ä½œæ‰€éœ€çš„ vcpu æ•°é‡ã€‚
*   **å†…å­˜:**ä½œä¸šæ‰€éœ€çš„å†…å­˜ã€‚
*   **jobRoleArn:** æ‚¨åœ¨ä¸Šé¢åˆ›å»ºçš„ EC2ContainerServiceTask è§’è‰²çš„ Arnã€‚
*   **å·:**ä¼ é€’ç»™ docker å®ˆæŠ¤è¿›ç¨‹çš„å·ã€‚
*   **ä¸»æœº:**æ•°æ®å·åœ¨å®¹å™¨ä¸Šçš„ä½ç½®ã€‚æˆ‘ä»¬å°†æŠŠå®ƒæŒ‡å‘æˆ‘ä»¬åœ¨ AMI ä¸Šå®‰è£…çš„ NVIDIA é©±åŠ¨ç¨‹åºã€‚
*   **åç§°:**å·çš„åç§°ã€‚
*   **æŒ‚è½½ç‚¹:**å®¹å™¨ä¸­å·çš„æŒ‚è½½ç‚¹ã€‚
*   **containerPath:** å®¹å™¨ä¸Šè£…è½½ä¸»æœºå·çš„è·¯å¾„ã€‚
*   **sourceVolume:** ä¸Šé¢æåˆ°çš„æºå·çš„åç§°ã€‚
*   **privileged:** è¿™èµ‹äºˆå®¹å™¨åœ¨ä¸»æœºå®¹å™¨å®ä¾‹ä¸Šçš„æ ¹ç‰¹æƒã€‚
*   **é‡è¯•ç­–ç•¥:**é‡è¯•å¤±è´¥ä½œä¸šçš„ç­–ç•¥ã€‚
*   **å°è¯•æ¬¡æ•°:**è¿è¡Œä½œä¸šçš„å°è¯•æ¬¡æ•°ã€‚æˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º 1ï¼Œè¿™è¡¨ç¤ºå¦‚æœå¤±è´¥å°±ä¸ä¼šé‡è¯•ã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä½œä¸šå®šä¹‰ã€‚

```
> aws batch register-job-definition --cli-input-json file://<path_to_json_file>/job_definition_spec.json
```

è¾“å‡ºåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/ddf6a8467521a23456254ca513484971.png)

**è®¾ç½®ä»£ç **

1.  åœ¨ Tensorflow ä»£ç æ–‡ä»¶å¤¹ä¸­åˆ›å»ºè¿è¡Œè„šæœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤º

$ SCRIPT _ DIR:S3 ç›®å½•è·¯å¾„ï¼ŒåŒ…å«è¿è¡ŒåŸ¹è®­çš„æ‰€æœ‰è„šæœ¬ã€‚

$MODEL_DIR:å­˜å‚¨æ£€æŸ¥ç‚¹çš„ s3 ç›®å½•è·¯å¾„ã€‚

$EXPORT_PATH:ä¿å­˜è®­ç»ƒå¥½çš„æ¨¡å‹çš„ s3 ç›®å½•è·¯å¾„ã€‚

$TRAINING_DATA:åŒ…å«è®­ç»ƒæ•°æ®çš„ CSV çš„ s3 è·¯å¾„ã€‚

$TEST_DATA:åŒ…å«æµ‹è¯•æ•°æ®çš„ CSV çš„ s3 è·¯å¾„ã€‚

æ‰¹å¤„ç†ä½œä¸šå°†é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’è¿™äº›å˜é‡çš„å€¼ã€‚

2.å°†æ‚¨çš„ Tensorflow ä»£ç ã€è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®ä¸Šä¼ åˆ° s3 ä¸­çš„æ–‡ä»¶å¤¹ã€‚(æ ·æœ¬è®­ç»ƒä»£ç å’Œæ•°æ®å¯å‚è€ƒ https://github.com/vigbk/tensorflow-ami-example[çš„](https://github.com/vigbk/tensorflow-ami-example)

**è¿è¡Œæ‰¹å¤„ç†ä½œä¸š**

åˆ›å»ºä»¥ä¸‹ JSON æ¥æŒ‡å®šæ‰¹å¤„ç†ä½œä¸šå‚æ•°

æŒ‰å¦‚ä¸‹æ–¹å¼è¿è¡Œæ‰¹å¤„ç†ä½œä¸šã€‚

```
aws batch submit-job --cli-input-json file://<path_to_json_file>/batch_job_spec.json
```

ä½œä¸šè¾“å‡ºåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/af575311c6d515cebbd9c36696469904.png)

æ‚¨å¯ä»¥é€šè¿‡ Amazon CloudWatch æ§åˆ¶å°æŸ¥çœ‹æ‚¨çš„ä½œä¸šæ—¥å¿—ï¼Œæˆ–è€…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä» cli è·å–å®ƒ

```
> aws logs get-log-events --log-group-name /aws/batch/job --log-stream-name TrainModel/default/876da822-4198-45f2-a252-6cea32512ea8--query events[*].message --limit 100
```

## è¿™å°±æ˜¯æ‰€æœ‰çš„äººâ€¦

æœ‰è®¸å¤šå³æ’å³ç”¨çš„è§£å†³æ–¹æ¡ˆå¯ä»¥åœ¨äº‘ä¸­ä½¿ç”¨ Tensorflow ç®¡ç†åŸ¹è®­ï¼Œä½†æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿè®©æ‚¨äº†è§£å¦‚ä½•å®šåˆ¶ Tensorflow åŸ¹è®­ï¼Œä»è€Œåœ¨ä¸ç‰ºç‰²æ€§èƒ½çš„æƒ…å†µä¸‹é™ä½æˆæœ¬ã€‚

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·éšæ„ç‚¹å‡»â€œé¼“æŒâ€æŒ‰é’®ğŸ‘å¸®åŠ©å…¶ä»–äººæ‰¾åˆ°å®ƒã€‚

**å‚è€ƒæ–‡çŒ®:-**

*   [https://docs . AWS . Amazon . com/batch/latest/user guide/batch-GPU-ami . html](https://docs.aws.amazon.com/batch/latest/userguide/batch-gpu-ami.html)
*   [https://docs . AWS . Amazon . com/AWS C2/latest/user guide/install-NVIDIA-driver . html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/install-nvidia-driver.html)

*æˆ‘æ˜¯å•°å—¦çš„é¡¹ç›®ç»´æŠ¤è€…ä¹‹ä¸€ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°æ®è½¬æ¢åº“ã€‚å¸®åŠ©æˆ‘ä»¬åœ¨ GitHub ä¸Šå®£ä¼ è¿™ä¸ªé¡¹ç›®:*[*https://github.com/productml/blurr*](https://github.com/productml/blurr)
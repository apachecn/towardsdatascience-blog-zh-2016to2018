<html>
<head>
<title>Python Code for Identifying Seasonal Customers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç”¨äºè¯†åˆ«å­£èŠ‚æ€§å®¢æˆ·çš„ Python ä»£ç </h1>
<blockquote>åŸæ–‡ï¼š<a href="https://towardsdatascience.com/python-code-for-identifying-seasonal-customers-4bd36dc7fcda?source=collection_archive---------5-----------------------#2018-07-01">https://towardsdatascience.com/python-code-for-identifying-seasonal-customers-4bd36dc7fcda?source=collection_archive---------5-----------------------#2018-07-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/528a43db452b9b3b4f614757f143ba28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SGnF7UCzkgH3hXf5O1HyqQ@2x.jpeg"/></div></div></figure><div class=""/><p id="dc6d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æˆ‘ä»¥å‰å†™è¿‡å¦‚ä½•ä½¿ç”¨æ—¶é—´åºåˆ—æ¥è¯†åˆ«æ•°æ®åº“ä¸­å…·æœ‰å­£èŠ‚æ€§ä½¿ç”¨æ¨¡å¼çš„å®¢æˆ·ã€‚å¦‚æœä½ æƒ³è¯¦ç»†äº†è§£ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ–‡ç« <a class="ae kz" href="http://www.kristenkehrer.com/seasonal-customer-time-series-analysis" rel="noopener ugc nofollow" target="_blank"/>ã€‚</p><p id="3757" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å¦‚æœæ‚¨æƒ³é•¿è¯çŸ­è¯´:ä¸ºäº†è¯†åˆ«å…·æœ‰å­£èŠ‚æ€§ä½¿ç”¨æ¨¡å¼çš„å®¢æˆ·ï¼Œæˆ‘é‡‡ç”¨äº†æŒ‰æœˆæ±‡æ€»çš„ customer_idã€æœˆã€å¹´å’Œä½¿ç”¨æ•°æ®ï¼Œå¹¶æŒ‰ idã€å¹´å’Œæœˆæ’åºã€‚æˆ‘ä»¬åªèƒ½è¯„ä¼°ä¸æˆ‘ä»¬åœ¨ä¸€èµ·è‡³å°‘ 2 å¹´çš„å®¢æˆ·çš„å­£èŠ‚æ€§ï¼Œä»¥å…è®¸ç®—æ³•è¯†åˆ«æ¨¡å¼ã€‚æ‰€ä»¥æ•°æ®(å®Œå…¨è™šæ„ï¼Œåªæ˜¯ä¸ºäº†è¯´æ˜)çœ‹èµ·æ¥åƒè¿™æ ·:</p><figure class="lb lc ld le gt iv gh gi paragraph-image"><div class="gh gi la"><img src="../Images/6c5cf8d2e769acf98d0b22b0059f506f.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/0*eU6JyWFP2ns8tV7j"/></div></figure><p id="f060" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ‚¨ä¼šæ³¨æ„åˆ°æ•°æ®ä¸­ç¼ºå°‘äº†äº”æœˆã€å…«æœˆã€ä¹æœˆå’Œåæœˆã€‚è¿™æ„å‘³ç€è¯¥å®¢æˆ·åœ¨é‚£å‡ ä¸ªæœˆæ²¡æœ‰ä»»ä½•ä½¿ç”¨ã€‚å› æ­¤ï¼Œç¬¬ä¸€é¡¹ä»»åŠ¡æ˜¯å¡«è¡¥æ•°æ®é›†ä¸­ç¼ºå¤±çš„é›¶ã€‚æˆ‘æŠŠæ•°æ®åº“é‡Œçš„æ•°æ®æ‹‰è¿›æ¥ï¼Œå‘½åä¸ºâ€œåŸåˆ›â€ã€‚è¿™é‡Œæˆ‘æ²¡æœ‰æä¾›è¿æ¥æ•°æ®åº“çš„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ Netezza SQLã€‚</p><p id="c2de" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ä»£ç å¦‚ä¸‹(æœ‰äº›ç¼©è¿›å¯¹äºè¾ƒé•¿çš„è¡Œæ˜¯ä¸æ­£ç¡®çš„ï¼ŒæŠ±æ­‰ï¼)ğŸ™‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1d39" class="lk ll je lg b gy lm ln l lo lp">import pandas as pa <br/>import numpy as np </span><span id="9352" class="lk ll je lg b gy lq ln l lo lp">## Outfile is just because we're going to export our results as a .csv to save them. </span><span id="83c8" class="lk ll je lg b gy lq ln l lo lp">outfile = '[put your file path here].csv' </span><span id="4e54" class="lk ll je lg b gy lq ln l lo lp">## Headings in the .csv that I'm going to output </span><span id="96f6" class="lk ll je lg b gy lq ln l lo lp">filledIn = pa.DataFrame(columns=['customer_id','yr','mnth','usage']) </span><span id="b894" class="lk ll je lg b gy lq ln l lo lp">##original was just the name of my dataframe with data </span><span id="a049" class="lk ll je lg b gy lq ln l lo lp">grouped = original.groupby(by='customer_id') <br/>def yearmonth_to_justmonth(year, month): <br/>     return year * 12 + month - 1 </span><span id="af3a" class="lk ll je lg b gy lq ln l lo lp">##Defining a function to fill in the zeros. </span><span id="82a9" class="lk ll je lg b gy lq ln l lo lp">def fillInForOwner(group): <br/>     min = group.head(1).iloc[0] <br/>     max = group.tail(1).iloc[0]       <br/>     minMonths = yearmonth_to_justmonth(min.yr, min.mnth) <br/>     maxMonths = yearmonth_to_justmonth(max.yr, max.mnth)<br/>     filled_index = pa.Index(np.arange(minMonths, maxMonths, 1),<br/>       name="filled_months") <br/>     group['months'] = group.yr * 12 + group.mnth - 1 <br/>     group = group.set_index('months') <br/>     group = group.reindex(filled_index) <br/>     group.customer_id = min.customer_id <br/>     group.yr = group.index // 12 group.mnth = group.index % 12 + 1<br/>     group.usage = np.where(group.usage.isnull(), 0,<br/>       group.usage).astype(int) <br/>     return group </span><span id="f59a" class="lk ll je lg b gy lq ln l lo lp">filledIn = grouped.apply(fillInForOwner) <br/>newIndex = pa.Index(np.arange(filledIn.customer_id.count())) </span><span id="b01f" class="lk ll je lg b gy lq ln l lo lp">## Printing out the results to a .csv <br/>filledIn = filledIn.set_index(newIndex) <br/>filledIn.to_csv(outfile)  </span><span id="aba9" class="lk ll je lg b gy lq ln l lo lp">## I also print results on the screen <br/>print(filledIn)</span></pre><p id="3e8e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘é€‰æ‹©åœ¨ Python ä¸­ä¸ºæ—¶é—´åºåˆ—éƒ¨åˆ†è¿è¡Œ Rã€‚å®é™…ä¸Šï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªå€¼å¾—ä¸€æçš„å°é—®é¢˜ã€‚æˆ‘åœ¨æˆ‘çš„è®¡ç®—æœºä¸Šå®‰è£…äº† 64 ä½å’Œ 32 ä½ç‰ˆæœ¬çš„ Rï¼Œå¹¶æŒ‡å‘è¿˜æ²¡æœ‰å®‰è£…æˆ‘çš„æ‰€æœ‰åŒ…çš„ R ç‰ˆæœ¬(æ¥è‡ª Python)ã€‚å°´å°¬çš„çœŸç›¸:æˆ‘æ‰‹åŠ¨å°†æ–‡ä»¶ä»ä¸€ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶ç²˜è´´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚æˆ‘ç¡®ä¿¡æœ‰ä¸€ç§æ›´â€œæ­£ç¡®â€çš„æ–¹æ³•ï¼Œä½†æ˜¯å°†å®ƒä»¬å¤åˆ¶å¹¶ç²˜è´´åˆ°ç›®å½•ä¸­æ­£ç¡®çš„æ–‡ä»¶å¤¹æ˜¯å¯è¡Œçš„ã€‚</p><p id="6ce7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”¨ Python è¿è¡Œ R ä»£ç å¹¶ä¸æ˜¯æˆ‘å°è¯•çš„ç¬¬ä¸€ç§æ–¹æ³•ã€‚æ‚¨å®é™…ä¸Šå¯ä»¥ä½¿ç”¨ Python è¯­è¨€æ¥è¿è¡Œ R ä»£ç ï¼Œä½†æ˜¯æˆ‘å¾ˆéš¾åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº† rpy2 è·¯çº¿ã€‚</p><p id="caff" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿™é‡Œæˆ‘å¯¼å…¥ rpy2 æ¥åˆ©ç”¨ Python ä¸­çš„ R ä»£ç ã€‚è¿™äº›ä¹Ÿæ˜¯æˆ‘éœ€è¦çš„æ‰€æœ‰åº“ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="6135" class="lk ll je lg b gy lm ln l lo lp">import rpy2 as r <br/>     from rpy2.robjects.packages import importr <br/>     from rpy2.robjects import r, pandas2ri, globalenv<br/>     pandas2ri.activate() </span><span id="0d88" class="lk ll je lg b gy lq ln l lo lp">base = importr('base') <br/>colorspace = importr('colorspace') <br/>forecast = importr('forecast') <br/>times = importr('timeSeries') <br/>stats = importr('stats')</span></pre><p id="b2e1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘é€ä¸€æŸ¥çœ‹äº†æ¯ä½é¡¾å®¢ã€‚æˆ‘ä¼šæ‰¾åˆ°ä»–ä»¬çš„å¼€å§‹æœˆä»½/å¹´ä»½å’Œç»“æŸæœˆä»½/å¹´ä»½ï¼Œå¹¶ä¸ºæ¯ä¸ªå®¢æˆ·åˆ›å»ºä¸€ä¸ªæ—¶é—´åºåˆ—å¯¹è±¡ã€‚æˆ‘åŒ…å«äº†ä¸€ä¸ª try/except è¯­å¥ï¼Œå› ä¸ºæˆ‘æœ€åˆå°è¯•åœ¨æ²¡æœ‰ try/except è¯­å¥çš„æƒ…å†µä¸‹è¿è¡Œå®ƒï¼Œåœ¨å®ƒå·²ç»è¿è¡Œäº†å‡ ä¸ªå°æ—¶ä¹‹åï¼Œå®ƒè¢«ä¸€ä¸ªå®¢æˆ·å¡ä½äº†ï¼Œä¸å¤ªç†æƒ³ã€‚</p><p id="8f9e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">åœ¨åˆ›å»ºäº†æ—¶é—´åºåˆ—å¯¹è±¡ä¹‹åï¼Œæˆ‘ç®€å•åœ°è¯¢é—® R æ¨¡å‹ä¸­æ˜¯å¦æœ‰å­£èŠ‚æ€§æˆåˆ†ï¼Œå¹¶æ‰“å°å‡ºå®¢æˆ· id ä»¥åŠå®ƒä»¬æ˜¯å¦æ˜¯å­£èŠ‚æ€§çš„ã€‚</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="f589" class="lk ll je lg b gy lm ln l lo lp"><br/>##Again, this is just for saving your results to a .csv <br/>outfile = '[put your file path here].csv' <br/>seasonal_output = pa.DataFrame(columns=['customer_id', 'seasonal']) </span><span id="577f" class="lk ll je lg b gy lq ln l lo lp">### Now we're going to loop through our customers <br/>for customerid, dataForCustomer in filledIn.groupby(by=['customer_id']): <br/>     startYear = dataForCustomer.head(1).iloc[0].yr <br/>     startMonth = dataForCustomer.head(1).iloc[0].mnth <br/>     endYear = dataForCustomer.tail(1).iloc[0].yr <br/>     endMonth = dataForCustomer.tail(1).iloc[0].mnth </span><span id="44e1" class="lk ll je lg b gy lq ln l lo lp">#Creating a time series object <br/>     customerTS = stats.ts(dataForOwner.SENDS.astype(int),<br/>          start=base.c(startYear,startMonth), <br/>          end=base.c(endYear, endMonth), frequency=12)<br/>     r.assign('customerTS', customerTS) </span><span id="b094" class="lk ll je lg b gy lq ln l lo lp">##Here comes the R code piece <br/>     try:  <br/>          seasonal = r(''' <br/>          fit&lt;-tbats(customerTS, seasonal.periods = 12, use.parallel<br/>          = TRUE) <br/>          fit$seasonal <br/>          ''') <br/>     except: <br/>          seasonal = 1 <br/>     seasonal_output = seasonal_output.append({'customer_id':<br/>          customerid, 'seasonal': seasonal}, ignore_index=True) <br/>     print(f' {customerid} | {seasonal} ') </span><span id="d95f" class="lk ll je lg b gy lq ln l lo lp">print(seasonal_output) <br/>seasonal_output.to_csv(outfile)</span></pre><p id="fbd8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">è¿™ä¸ªè¾“å‡ºå°†æˆä¸ºæˆ‘æ­£åœ¨è¿›è¡Œçš„èšç±»åˆ†æçš„ä¸€ä¸ªç‰¹å¾ã€‚æˆ‘è¿˜å°†åšä¸€äº›å·¥ä½œæ¥ç¡®å®šæ¯ä¸ªå®¢æˆ·çš„æœ€å°å’Œæœ€å¤§ä½¿ç”¨æœˆæ•°ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚å¾ˆå¿«ï¼Œå¸‚åœºè¥é”€å°†èƒ½å¤Ÿåˆ©ç”¨è¿™ä¸€ç‚¹æ¥å¼€å±•æ›´åŠ ä¸ªæ€§åŒ–çš„æ´»åŠ¨ã€‚</p><p id="dbb9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">å¦‚æœä½ æƒ³è®¢é˜…æˆ‘æœªæ¥çš„æ–‡ç« ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œè®¢é˜…ã€‚</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><p id="061b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="ly">åŸè½½äº 2018 å¹´ 7 æœˆ 1 æ—¥</em><a class="ae kz" href="https://datamovesme.com/2018/07/01/seasonality-python-code/" rel="noopener ugc nofollow" target="_blank"><em class="ly">ã€datamovesme.comã€‘</em></a><em class="ly">ã€‚</em></p></div></div>    
</body>
</html>
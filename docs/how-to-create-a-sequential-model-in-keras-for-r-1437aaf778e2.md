# å¦‚ä½•åœ¨ Keras ä¸­ä¸º R åˆ›å»ºåºåˆ—æ¨¡å‹

> åŸæ–‡ï¼š<https://towardsdatascience.com/how-to-create-a-sequential-model-in-keras-for-r-1437aaf778e2?source=collection_archive---------14----------------------->

TLï¼›dr:æœ¬æ•™ç¨‹å°†ä»‹ç» Keras çš„æ·±åº¦å­¦ä¹ åˆ†ç±»ä»»åŠ¡ã€‚æˆ‘ä»¬å°†ç‰¹åˆ«å…³æ³¨æ•°ç»„çš„å½¢çŠ¶ï¼Œè¿™æ˜¯æœ€å¸¸è§çš„é™·é˜±ä¹‹ä¸€ã€‚

æˆ‘ä»¬å°†è®¨è®ºçš„ä¸»é¢˜æœ‰:

*   å¦‚ä½•è¿›è¡Œä¸€é”®ç¼–ç 
*   é€‰æ‹©å±‚ä¸­çš„è¾“å…¥å’Œè¾“å‡ºå½¢çŠ¶/å°ºå¯¸
*   å¦‚ä½•è®­ç»ƒæ¨¡å‹
*   å¦‚ä½•è¯„ä¼°æ¨¡å‹(åŸ¹è®­ä¸æµ‹è¯•)

ä½ å¯ä»¥åœ¨ Github ä¸Šæ‰¾åˆ°[è¿™ä¸ªæ•™ç¨‹çš„å®Œæ•´ä»£ç ğŸ‘‡](https://github.com/pablo14/Keras-R-tutorials/blob/master/keras_sequential_model.R)

![](img/6014b80babba9514c4f1dc21ed691477.png)

# åˆ›å»ºæ•°æ®

è¾“å…¥æ•°æ®å°†æ˜¯æ¥è‡ªå‡åŒ€åˆ†å¸ƒçš„ 10000 è¡Œå’Œ 3 åˆ—ã€‚

# åˆ›å»ºæ•°æ®

è¾“å…¥æ•°æ®å°†æ˜¯æ¥è‡ªå‡åŒ€åˆ†å¸ƒçš„ 10000 è¡Œå’Œ 3 åˆ—ã€‚

è¯¥æ¨¡å‹å°†è¯†åˆ«å‡ºè¿™ä¸‰ä¸ªæ•°å­—çš„æ€»å’Œé«˜äºé˜ˆå€¼`1.5`ï¼Œå¦åˆ™å°†ä¸º 0ã€‚

```
# Input: 10000 rows and 3 columns of uniform distribution
x_data=matrix(data=runif(30000), nrow=10000, ncol=3)# Output
y_data=ifelse(rowSums(x_data) > 1.5, 1, 0)head(x_data)##            [,1]      [,2]      [,3]
## [1,] 0.49224109 0.6096538 0.7855929
## [2,] 0.56710301 0.8707570 0.3428543
## [3,] 0.08246592 0.7504529 0.6979251
## [4,] 0.79197829 0.6330420 0.7307403
## [5,] 0.65170373 0.9052915 0.1395298
## [6,] 0.23479406 0.2611791 0.2780037head(y_data)## [1] 1 1 1 1 1 0
```

# å®‰è£…/åŠ è½½ Keras

```
# install.packages("keras")
library(keras)
library(tidyverse)
```

# Keras ä¸­çš„ä¸€é”®ç¼–ç 

æ·±åº¦å­¦ä¹ çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ç†è§£æ¨¡å‹éœ€è¦çš„å‘é‡ã€çŸ©é˜µå’Œ/æˆ–æ•°ç»„çš„ç»´æ•°ã€‚æˆ‘å‘ç°è¿™äº›éƒ½æ˜¯ Keras æ”¯æŒçš„ç±»å‹ã€‚

ç”¨ Python çš„è¯è¯´ï¼Œå°±æ˜¯æ•°ç»„çš„å½¢çŠ¶ã€‚

ä¸ºäº†å®ŒæˆäºŒè¿›åˆ¶åˆ†ç±»ä»»åŠ¡ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå•çƒ­ç‚¹å‘é‡ã€‚å¯¹äº 2 ä¸ªä»¥ä¸Šçš„ç±»ï¼Œå®ƒä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œã€‚

ä¾‹å¦‚:

*   å€¼`1`å°†æ˜¯çŸ¢é‡`[0,1]`
*   å€¼`0`å°†æ˜¯çŸ¢é‡`[1,0]`

Keras æä¾›äº†`to_categorical`å‡½æ•°æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚

```
y_data_oneh=to_categorical(y_data, num_classes = 2)head(y_data_oneh)##      [,1] [,2]
## [1,]    0    1
## [2,]    0    1
## [3,]    0    1
## [4,]    0    1
## [5,]    0    1
## [6,]    1    0
```

å¾ˆå®¹æ˜“å¾—åˆ°åˆ†ç±»å˜é‡ï¼Œå¦‚:â€œæ˜¯/å¦â€ã€â€œCatAã€CatBã€CatCâ€ç­‰ã€‚ä½†æ˜¯`to_categorical`ä¸æ¥å—éæ•°å€¼ä½œä¸ºè¾“å…¥ã€‚æˆ‘ä»¬éœ€è¦é¦–å…ˆè½¬æ¢å®ƒä»¬ã€‚

`num_classes`æ˜¯åˆ›å»ºçŸ¢é‡é•¿åº¦æ‰€å¿…éœ€çš„ã€‚

`to_categorical`çš„æ›¿ä»£å“:

*   åŒ…`CatEncoders`ï¼Œ [OneHotEncoder](https://cran.r-project.org/web/packages/CatEncoders/CatEncoders.pdf) (åŒ Python `scikit-learn`)ã€‚
*   å°è£…`caret`ï¼ŒåŠŸèƒ½ [dummyVars](https://amunategui.github.io/dummyVar-Walkthrough/) ã€‚

æ³¨æ„:æˆ‘ä»¬ä¸éœ€è¦è½¬æ¢**è¾“å…¥å˜é‡**ï¼Œå› ä¸ºå®ƒä»¬æ˜¯æ•°å€¼ã€‚

# åœ¨ Keras ä¸­åˆ›å»ºé¡ºåºæ¨¡å‹

Keras ä¸­æœ€ç®€å•çš„æ¨¡å‹æ˜¯**åºåˆ—**ï¼Œå®ƒæ˜¯é€šè¿‡é¡ºåºå †å å±‚è€Œæ„å»ºçš„ã€‚

åœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å †å äº†ä¸‰ä¸ªå¯†é›†å›¾å±‚ï¼Œkeras ä½¿ç”¨ input_shape å‚æ•°ç”¨æ‚¨çš„æ•°æ®æ„å»ºäº†ä¸€ä¸ªéšå¼è¾“å…¥å›¾å±‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ€»å…±æœ‰ä¸€ä¸ªè¾“å…¥å±‚å’Œä¸€ä¸ªè¾“å‡ºå±‚ã€‚

```
model = keras_model_sequential() %>%   
  layer_dense(units = 64, activation = "relu", input_shape = ncol(x_data)) %>%
  layer_dense(units = 64, activation = "relu") %>%
  layer_dense(units = ncol(y_data_oneh), activation = "softmax")
```

ç›®å‰æœ€é‡è¦çš„å‚æ•°æ˜¯:

*   åœ¨ç¬¬ä¸€å±‚ä¸­ï¼Œ`input_shape`ä»£è¡¨ä¸€ä¸ªå€¼ä¸º 3 ( `ncol(x_data)`)çš„å‘é‡ï¼Œè¡¨ç¤ºè¾“å…¥å˜é‡çš„æ•°é‡ã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œå‡ ä¹æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯å‘é‡(æˆ–å¼ é‡)ã€‚
*   ç¬¬äºŒå±‚æ²¡æœ‰`input_shape`ï¼Œå› ä¸º Keras æ˜¯ä»å‰ä¸€å±‚æ¨æ–­å‡ºæ¥çš„ã€‚
*   ç¬¬ä¸‰ä¸ª`layer_dense`ï¼Œä»£è¡¨æœ€ç»ˆè¾“å‡ºï¼Œæœ‰ 2 ä¸ª(`ncol(y_data_oneh)`)å•ä½ä»£è¡¨ä¸¤ç§å¯èƒ½çš„ç»“æœã€‚

æ‚¨å¯ä»¥æ£€æŸ¥æ¯ä¸ªå›¾å±‚çš„æ¨¡å‹å’Œå½¢çŠ¶:

```
model## Model
## ___________________________________________________________________________
## Layer (type)                     Output Shape                  Param #     
## ===========================================================================
## dense_28 (Dense)                 (None, 64)                    256         
## ___________________________________________________________________________
## dense_29 (Dense)                 (None, 64)                    4160        
## ___________________________________________________________________________
## dense_30 (Dense)                 (None, 2)                     130         
## ===========================================================================
## Total params: 4,546
## Trainable params: 4,546
## Non-trainable params: 0
## ___________________________________________________________________________
```

ç°åœ¨æ˜¯æ—¶å€™å®šä¹‰æŸå¤±å’Œä¼˜åŒ–å™¨å‡½æ•°ï¼Œä»¥åŠè¦ä¼˜åŒ–çš„æŒ‡æ ‡äº†ã€‚

è™½ç„¶å®ƒè¯´çš„æ˜¯â€œå‡†ç¡®æ€§â€ï¼Œä½† keras è¯†åˆ«è¾“å‡ºçš„æ€§è´¨(åˆ†ç±»)ï¼Œå¹¶åœ¨åç«¯ä½¿ç”¨`categorical_accuracy`ã€‚

```
compile(model, loss = "categorical_crossentropy", optimizer = optimizer_rmsprop(), metrics = "accuracy")
```

è®©æˆ‘ä»¬æ¥æ‹Ÿåˆ(è®­ç»ƒ)æ¨¡å‹:

```
history = fit(model,  x_data, y_data_oneh, epochs = 20, batch_size = 128, validation_split = 0.2)
```

![](img/e3fd0a09392b8efabbf144219aca55c3.png)

æå®šäº†ã€‚

ç»˜å›¾ç»“æœ:

```
plot(history)
```

![](img/58257ed6a602b2d25ede8c333af309e6.png)

Keras results in ggplot2

# ç”¨çœ‹ä¸è§çš„æ•°æ®éªŒè¯

åˆ›å»ºâ€œçœ‹ä¸è§çš„â€è¾“å…¥æµ‹è¯•æ•°æ®(1000 è¡Œï¼Œ3 åˆ—):

```
x_data_test=matrix(data=runif(3000), nrow=1000, ncol=3)
dim(x_data_test)## [1] 1000    3
```

é¢„æµ‹æ–°ç—…ä¾‹:

```
y_data_pred=predict_classes(model, x_data_test)glimpse(y_data_pred)##  num [1:1000(1d)] 0 0 1 1 1 1 0 1 0 1 ...
```

è¯·æ³¨æ„ï¼Œç»´åº¦æ˜¯ 1000 è¡Œå’Œ 2 åˆ—ã€‚`predict_classes`è‡ªåŠ¨æ‰§è¡Œä¸€é”®è§£ç ã€‚

ç›¸åï¼Œ`predict`è¿”å›è®­ç»ƒæ—¶æ”¶åˆ°çš„ç›¸åŒç»´åº¦(n è¡Œï¼Œn ç±»é¢„æµ‹)ã€‚

```
y_data_pred_oneh=predict(model, x_data_test)dim(y_data_pred_oneh)## [1] 1000    2head(y_data_pred_oneh)##                     [,1]              [,2]
## [1,] 0.99207872152328491 0.007921278476715
## [2,] 1.00000000000000000 0.000000001157425
## [3,] 0.00000002739444227 1.000000000000000
## [4,] 0.41273152828216553 0.587268412113190
## [5,] 0.03470309823751450 0.965296924114227
## [6,] 0.00000000007147296 1.000000000000000
```

åœ¨åˆ†ç±»ä¸­ï¼Œæ€»æ˜¯å»ºè®®è¿”å›æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ï¼Œå°±åƒæˆ‘ä»¬å¯¹`predict`æ‰€åšçš„é‚£æ ·(è¡Œå’Œä¸º 1)ã€‚æ›´å¤šä¿¡æ¯è¯·è®¿é—®: [DSLB -å¾—åˆ†æ•°æ®](https://livebook.datascienceheroes.com/model-performance.html#scoring_data)ã€‚

# softmax æ¿€æ´»

å¤šäºäº†æœ€åä¸€å±‚çš„`activation = "softmax"`,æˆ‘ä»¬å¾—åˆ°äº†æ¦‚ç‡ã€‚

å¯¹äºæ¯ä¸ªç±»ï¼Œsoftmax çš„è¾“å‡ºèŒƒå›´ä» 0 åˆ° 1ï¼Œæ‰€æœ‰ç±»çš„æ€»å’Œè‡ªç„¶æ˜¯ 1ã€‚

# è¯„ä¼°æ¨¡å‹(åŸ¹è®­ä¸æµ‹è¯•)

åˆ›å»ºâ€œçœŸå®â€y ç›®æ ‡ï¼Œä¸é¢„æµ‹ç›®æ ‡è¿›è¡Œæ¯”è¾ƒ:

```
y_data_real=ifelse(rowSums(x_data_test) > 1.5, 1, 0)
y_data_real_oneh=to_categorical(y_data_real)## Training data
evaluate(model, x_data, y_data_oneh, verbose = 0)## $loss
## [1] 0.03008356
## 
## $acc
## [1] 0.9918## Test data (we need the one-hot version)
evaluate(model, x_data_test, y_data_real_oneh, verbose = 0)## $loss
## [1] 0.03146484
## 
## $acc
## [1] 0.991
```

çœ‹ä¸è§çš„æ•°æ®çš„ç²¾åº¦å‡ ä¹æ˜¯å®Œç¾çš„:å¤§çº¦åœ¨`1`(ä»¥åŠæ¥è¿‘ 0 çš„æŸå¤±ï¼Œè¿™æ¯”ç²¾åº¦æ›´é‡è¦)ã€‚

ç¥ç»ç½‘ç»œå­¦ä¹ äº†æˆ‘ä»¬ä¸€å¼€å§‹å®šä¹‰çš„æ¨¡å¼ğŸ‰ï¼

![](img/713ed617989690b5b66fa33f497ba638.png)

# ä¸€äº›é—®é¢˜ğŸ¤”

*éœ€è¦å¤šå°‘å±‚ï¼Ÿ*æˆ‘ä»¬å°è¯•äº† 3ï¼Œä½†æ˜¯ 4 æ€ä¹ˆæ ·ï¼Ÿå®ƒå°†å­¦ä¹ åŒæ ·çš„ä¸œè¥¿ï¼Œä½†æ˜¯éœ€è¦æ›´å¤šçš„æ—¶é—´ã€‚ä½†æ˜¯åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œæ€§èƒ½ä¼šæé«˜ã€‚è¿™å–å†³äºæ¯ä¸ªæ¡ˆä¾‹ã€‚

*æ¯å±‚éœ€è¦å¤šå°‘ä¸ªç¥ç»å…ƒï¼Ÿ*å’Œä»¥å‰ä¸€æ ·çš„æ¨ç†ã€‚æˆ‘ä»¬åº”è¯¥æœŸæœ›ç”¨æœ€ç®€å•çš„ç½‘ç»œè·å¾—æœ€å¤§çš„ç²¾åº¦ã€‚å€¾å‘äºè¿›è¡Œè‰¯å¥½çš„æ ‡å‡†æ‹Ÿåˆçš„ä¸€ç§æ–¹æ³•æ˜¯ä»å…·æœ‰(å³)128 ä¸ªç¥ç»å…ƒçš„å±‚å¼€å§‹ã€‚ç„¶ååŠ ä¸€å±‚ 64ï¼Œå¦ä¸€å±‚ 16ã€‚æ¨¡å¼æ˜¯å‡å°‘æ¯å±‚ç¥ç»å…ƒçš„æ•°é‡ã€‚

# ä½ è‡ªå·±è¯•è¯•ğŸ™Œ

é˜…è¯»åªæ˜¯å­¦ä¹ çš„ä¸€ä¸ªå¾ˆå°çš„éƒ¨åˆ†ï¼Œä½ å¯ä»¥è‡ªå·±å°è¯•ï¼Œæ¯”å¦‚æ”¹å˜æˆ‘ä»¬ä½¿ç”¨çš„å‡½æ•°(æˆ‘ä»¬å°è¯•äº†`y > 1.5 = 1`)å¹¶è®©ç½‘ç»œæ¥å­¦ä¹ å®ƒã€‚

é€šè¿‡ç¼–ç å­¦ä¹ ï¼Œå¹¶æš´éœ²ä½ çš„å®è·µä¸­çš„é”™è¯¯ğŸ™‚

# è¿›ä¸€æ­¥é˜…è¯»

*   [ç³»åˆ—è½¦å‹æŒ‡å—](https://keras.rstudio.com/articles/sequential_model.html)(æ¥è‡ª Rstudio)
*   [R ä¸­æ·±åº¦å­¦ä¹ å…¥é—¨](https://blog.rstudio.com/2018/09/12/getting-started-with-deep-learning-in-r)(æ¥è‡ª Rstudio)
*   [æ ·æœ¬å¤§å°å’Œç±»åˆ«å¯¹æ¨¡å‹æ€§èƒ½çš„å¹³è¡¡](https://blog.datascienceheroes.com/sample-size-and-class-balance-on-model-performance)(åº•å±‚æ¨¡å‹æ˜¯ç”¨ Keras æ„å»ºçš„)

*æœ¬å¸–æœ€åˆå‘å¸ƒäº:*[*https://blog . datascienceheroes . com/how-to-create-a-sequential-model-in-keras-for-r/*](https://blog.datascienceheroes.com/how-to-create-a-sequential-model-in-keras-for-r/)

æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼ŸæŠŠå®ƒä»¬ç•™åœ¨ä¸‹é¢ğŸ“©

**æ„Ÿè°¢**é˜…è¯»ï¼ğŸš€

ğŸ“—[æ•°æ®ç§‘å­¦ Live Book](http://livebook.datascienceheroes.com/) â€”å­¦ä¹ æœºå™¨å­¦ä¹ çš„åœ¨çº¿ä¹¦ç±

[æ›´å¤šæ•°æ®æ•…äº‹:åšå®¢](https://blog.datascienceheroes.com/how-to-create-a-sequential-model-in-keras-for-r/blog.datascienceheroes.com)|[Linkedin](https://www.linkedin.com/in/pcasas/)|[Twitter](https://twitter.com/pabloc_ds)